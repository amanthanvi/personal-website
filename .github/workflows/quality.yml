name: Content Quality

on:
  pull_request:
  push:
    branches: [ "main", "master" ]

jobs:
  lint-markdown:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for markdown files
        id: check_files
        run: |
          if compgen -G "content/**/*.md" > /dev/null; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi
      - uses: DavidAnson/markdownlint-cli2-action@v20
        if: steps.check_files.outputs.has_files == 'true'
        with:
          globs: 'content/**/*.md'
        continue-on-error: true
          
  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows/
        continue-on-error: true
          
  spellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: codespell-project/actions-codespell@v2
        with:
          check_filenames: true
          ignore_words_list: adn,aman,thanvi,doj,ustp,cisa,nasa,umd,sdls,cfs,nos3,ccds,ngn,scan,ltsc,eoust,govt,config
          skip: ./themes,./public,./resources,./static/fonts,./.git,./node_modules,./go.sum,./go.mod
        continue-on-error: true
          
  link-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone theme if missing
        run: |
          if [ ! -d "themes/blowfish" ]; then
            git clone https://github.com/nunocoracao/blowfish.git themes/blowfish
          fi
      - name: Setup Hugo
        uses: actions/setup-hugo@v3
        with:
          hugo-version: '0.148.2'
          extended: true
      - name: Build site
        run: hugo --minify
        continue-on-error: true
      - name: Check if public exists
        id: check_public
        run: |
          if [ -d "public" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Public directory not created"
          fi
      - name: Lychee link check
        if: steps.check_public.outputs.exists == 'true'
        uses: lycheeverse/lychee-action@v1
        with:
          args: --no-progress --max-concurrency 5 --verbose './public/**/*.html'
          fail: false
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        continue-on-error: true